<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration</title>

    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Cabin+Sketch:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"></script>
</head>

<body>

    <div class="preview">
        <span>VORSCHAU</span>
    </div>

    <div class="form">
        <h2>Neue Münze</h2>

        <h3>WICHTIG</h3>
        <p>Dies ist eine Vorschau, die zur Feststellung der Bedienbarkeit und der Nutzerfreundlichkeit dient.
        </p>
        <p>Das Design hat in keinster Weise Anspruch auf einen ästhetischen Wert und wird sich, den Anforderungen nach,
            noch drastisch ändern.</p>
        <p>Die Schrift hat diesen Zeichenstil nicht, weil dieser 'schön' sein soll, sondern um dies zu verdeutlichen!
        </p>

        <p class="important">Das Wichtige sind hier die Eingabefelder und deren Bedienbarkeit.</p>


        <h3>Grunddaten</h3>

        <label for="">Typnummer</label>
        <input type="text">
        <p>
            Das Arbeiten nur mit Tastatur ist meist schneller und angenehmer, als das ständige Wechseln zwischen Tastatur und Maus.
            Daher ist es oft angenehmer, die Felder über die Tab-Taste zu wechseln.
        </p>

        <label for="">Treadwell-Id</label>
        <input type="text">


        <label for="">Material</label>
        <div class="data-select" data-select="material" data-select-attribute="name" style="position: relative;">
        </div>

        <p>
            Felder mit einem + sind 'Datenbankfelder', wenn man Text in das Textfeld eingibt, werden vorhandene Daten durchsucht und passende Vorschläge angezeigt.
            Mit Klick auf den Vorschlag wird dieser übernommen. Ist ein valider Wert angegeben, erscheint entweder eine Zahl und das rote Plus verschwindet. Oder man 
            klickt auf das rote Plus (oder die Enter-Taste) um den Wert einzufügen.
        </p>
        <p class="important">
            Dies verhindert das versehentlich falsche Werte in ein Textfeld eingegeben werden, außerdem erlaubt es flexibel neue Werte hinzuzufügen.
        </p>

        <label for="">Münzstätte</label>
        <div class="data-select" data-select="staette" data-select-attribute="name" style="position: relative;">
        </div>

        <label for="">Prägejahr</label>
        <div class="synchronized-calendar">
            <div class="calendar">
                <label for="">Arabisch</label><input type="text" data-arabic>
            </div>
            <div class="calendar">
                <label for="">Gregorianisch</label><input type="text" data-gregorian>
            </div>
        </div>
        <p>
            Die Jahreszahlen sind bidirectional synchronisiert. Wird ein Eingabefeld geändert, so wird das andere
            geupdated.
            Dieses 'update' passiert erst, wenn der außerhalb des Feldes geklickt oder ein neues Feld angewählt wird.
        </p>
        <p>
            Es kann auch mit einem kleinen x gearbeitet werden, wenn entsprechende Daten nicht bekannt sind. Dann wird
            das synchronisierte Feld 'falsch' aktualisiert.
            Im Moment gehe ich davon aus, dass wenn ein x gesetzt wird, alle kleineren Werte des anderen Feldes nicht
            mehr berechenbar sind.
        </p>

        <h3>Islamische Münze</h3>

        <label for="">Nominal</label>
        <div class="data-select" data-select="nominal" data-select-attribute="name" style="position: relative;">
            <input type="search" name="" id="">
            <span style="display:block; position: absolute; top:0; right:0; z-index: 1000;">SEARCH</span>
        </div>

        <p>Bei 'Datenbankfeldern' kann die Vorschauliste mit den Pfeiltasten durchsucht werden. Das aktive Element kann mit "Enter" ausgewählt werden.</em></p>
     

        <label for="">Münzherr</label>
        <div class="titled-person-select" master></div>
        <p>Ist das gesuchte Feld nicht vorhanden, kann es mit "Enter" hinzuzufügen werden. Der Cursor springt dann automatisch in das nächste Feld.</em></p>
     
        <label for="">Kalif</label>
        <div class="titled-person-select"></div>

        <div class="conditional-field">
            <div class="label"><input type="checkbox" id="is-designated"><label for="is-designated">Designierter
                    Nachfolger?</label></div>
            <div class="conditional hidden">
                <div class="titled-person-select"></div>
            </div>
        </div>

        <label for="">Oberherren</label>
        <div class="oberherren list" data-numbered data-type="person" data-num=4></div>
        <span class="comment">* wobei 1 der höchste Oberherr ist</span>


        <label for="">Weitere Personen</label>

        <div class="other-persons list" data-type="type-person" data-num=1>
        </div>


        <hr>
        <h3>Vorderseite</h3>

        <label for="">Feld</label>
        <div class="exemplare list" data-type="positional" data-num=1>
            <button>+</button>
            <div class="list-item">
                <div class="positional"><input type="text"><textarea></textarea></div><button>-</button>
            </div>
        </div>

        <label for="">Umschrift</label>
        <div class="exemplare list reverse" data-type="text" dir="rtl" data-num=2>
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>

        </div>

        <h3>Rückseite</h3>

        <label for="">Feld</label>
        <div class="exemplare list" data-type="positional" data-num=1>
            <button>+</button>
            <div class="list-item">
                <div class="positional"><input type="text"><textarea></textarea></div><button>-</button>
            </div>
        </div>

        <label for="">Umschrift</label>
        <div class="exemplare list reverse" data-type="text" dir="rtl" data-num=2>
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>

        </div>

        <hr>
        <h3>Weitere Informationen</h3>
        <label for="">Literatur</label>
        <div class="literature list">
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>
        </div>

        <label for="">Exemplare</label>
        <div class="exemplare list">
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>
        </div>


        <label for="">Varianten</label>
        <div class="variants list">
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>
        </div>

        <label for="">Besonderheiten</label>
        <textarea></textarea>

        <button id="submit">Speichern</button>
    </div>

    <script src="https://rawgit.com/abdennour/hijri-date/master/cdn/hijri-date-latest.js"></script>
    <script>



        let defaultData = {
            staette: [

            ],
            material: [
                { id: 0, name: "gold" },
                { id: 1, name: "silver" },
                { id: 2, name: "copper" },
            ],
            person: [
                { id: 0, name: "آدَم" },
                { id: 1, name: "أدْرِيَان" },
                { id: 2, name: "أليساندرو" },
                { id: 3, name: "دافيدي" },
                { id: 4, name: "إسْتَبْرَق" },
            ],
            nominal: [
                { id: 0, name: "dirham" },
                { id: 1, name: "halb-dirham" },
            ]
        }


        let loadedData
        try {
            loadedData = JSON.parse(localStorage.getItem("data"))
        } catch (err) {
            console.error(err)
        }

        const data = loadedData || defaultData


        submit.addEventListener("click", () => {
            console.log("YOUR VALUES HAVE BEEN SAVED! GJ")
            window.isDirty = false
        })

        // window.addEventListener("beforeunload", (event) => {
        //     console.log("beforeunload")
        //     // Message will be only shown for legacy browsers.
        //     // Modern browsers provide a boilerplate message for preventing scam!
        //     const msg = "Your changes may be lost."
        //     if (window.isDirty)
        //         event.returnValue = msg

        //     return msg;
        // })

        document.querySelectorAll(".list").forEach(initializeList)
        document.querySelectorAll(".conditional-field").forEach(initializeConditionalField)

        document.querySelectorAll("input, textarea").forEach(el => {
            el.addEventListener("input", setDirty)
        })

        function setDirty() {
            window.isDirty = true
        }

        function initializeConditionalField(el) {
            const checkbox = el.querySelector("input[type=checkbox]")
            const conditional = el.querySelector(".conditional")

            checkbox.addEventListener("input", event => {
                if (event.target.checked == true) {
                    conditional.classList.remove("hidden")
                } else {
                    conditional.classList.add("hidden")

                }
            })
        }

        document.querySelectorAll(".synchronized-calendar").forEach(initializeSynchronizedCalendar)


        function initializeSynchronizedCalendar(el) {
            const gregorianTextField = el.querySelector("input[data-gregorian]")
            const arabicTextField = el.querySelector("input[data-arabic]")

            if (!gregorianTextField) console.error("Synchronized calendar is missing data-gregorian element.")
            if (!arabicTextField) console.error("Synchronized calendar is missing data-arabic element.")

            if (gregorianTextField && arabicTextField) {

                function destructureDate(event) {
                    const value = event.target.value
                    const parts = value.split(".")

                    while (parts.length < 3) {
                        parts.unshift("XX")
                    }

                    let day = parts[0].toString().substr(-2).padStart(2, "0")
                    let month = parts[1].toString().substr(-2).padStart(2, "0")
                    const year = parts[2].toString().substr(-4).padStart(4, "0")

                    return [
                        day,
                        month,
                        year
                    ]

                }

                function allowInput(event, regex) {
                    if (event.key.length > 1) return

                    if (event.target.value.length >= 10) event.preventDefault()
                    else if (!regex.test(event.key)) {
                        event.preventDefault()
                    } else {

                        if (event.target.value.length == 2 || event.target.value.length == 5) {
                            if (event.key != ".") event.target.value += "."
                        }
                    }
                }

                [gregorianTextField, arabicTextField].forEach(field => {
                    field.addEventListener("paste", (event) => {
                        event.preventDefault()
                    })

                    field.addEventListener("keydown", (event) => {
                        allowInput(event, /[0-9x]/g)
                    })
                })

                gregorianTextField.addEventListener("change", (event) => {
                    const destructuredDate = destructureDate(event)
                    event.target.value = destructuredDate.join(".")


                    const day = parseInt(destructuredDate[0]) - 1 || 1
                    const month = parseInt(destructuredDate[1]) - 1 || 0
                    const year = parseInt(destructuredDate[2]) || 0

                    console.log({
                        day, month, year
                    })

                    let date = new Date(year, month, day)

                    const hijri = date.toHijri()
                    arabicTextField.value = [hijri.getDate().toString().padStart(2, "0"), hijri.getMonth().toString().padStart(2, "0"), hijri.getFullYear().toString().padStart(4, "0")].join(".")
                })

                arabicTextField.addEventListener("change", (event) => {
                    const destructuredDate = destructureDate(event)
                    event.target.value = destructuredDate.join(".")


                    const day = parseInt(destructuredDate[0]) + 1 || 1
                    const month = parseInt(destructuredDate[1]) + 1 || 0
                    const year = parseInt(destructuredDate[2]) || 0

                    console.log({
                        day, month, year
                    })

                    let date = new HijriDate(year, month, day)

                    const hijri = date.toGregorian()
                    gregorianTextField.value = [hijri.getDate().toString().padStart(2, "0"), hijri.getMonth().toString().padStart(2, "0"), hijri.getFullYear().toString().padStart(4, "0")].join(".")
                })
            }

        }


        function createProfessionesPersonSelect() {
            const el = document.createElement("div")
            el.className = "profession-person-select"


            const dataSelect = createDataSelectField("profession")
            initializeDataSelect(dataSelect)


            el.appendChild(dataSelect)
            el.appendChild(createTitledPersonSelect())

            console.trace("CALLED TRACE")
            const inputField = dataSelect.querySelector(".data-select-search")
            console.log(inputField)
            inputField.setAttribute("placeholder", "Tätigkeit")

            return el
        }


        function createTitledPersonSelect() {
            const el = document.createElement("div")
            el.className = "titled-person-select"
            initializeTitledPersonSelect(el)
            return el
        }

        function initializeTitledPersonSelect(el) {
            el.innerHTML = ""
            el.appendChild(createTitleField())
            el.appendChild(createPersonField())
        }


        function createDataSelectField(table, attribute = "name") {
            const el = document.createElement("div")
            el.className = "data-select"
            el.setAttribute("data-select", table)
            el.setAttribute("data-select-attribute", attribute)
            return el
        }

        function createPersonField() {
            const el = createDataSelectField("person")
            initializeDataSelect(el)
            const inputField = el.querySelector(".data-select-search")
            inputField.setAttribute("dir", "rtl")
            inputField.setAttribute("placeholder", "Name")
            el.classList.add("person-select")
            return el
        }

        function createTitleField() {
            const el = createDataSelectField("title")
            initializeDataSelect(el)
            const inputField = el.querySelector(".data-select-search")
            inputField.setAttribute("dir", "rtl")
            inputField.setAttribute("placeholder", "Titel")
            el.classList.add("title-select")
            return el
        }


        function initializeList(list) {
            list.innerHTML = ""

            const num = list.getAttribute("data-num") || 0

            let addBtn = document.createElement("button")
            addBtn.textContent = "+"
            list.appendChild(addBtn)


            let listItems = document.createElement("div")
            listItems.className = "list-items"
            list.appendChild(listItems)

            addBtn.addEventListener("click", addListItem)

            for (let i = 0; i < num; i++) {
                const listItem = createListItem(list)
                listItems.appendChild(listItem)
            }
            listChanged(list)
        }

        function createListItem(list) {
            const type = list.getAttribute("data-type") || "text"
            const wrapper = document.createElement("div")
            wrapper.className = "list-item"

            switch (type) {
                case "positional":
                    const positional = document.createElement("div")
                    positional.className = "positional"
                    wrapper.appendChild(positional)

                    const pinput = document.createElement("input")
                    positional.appendChild(pinput)

                    const textarea = document.createElement("textarea")
                    textarea.setAttribute("dir", "rtl")
                    positional.appendChild(textarea)
                    break;

                case "type-person":
                    wrapper.appendChild(createProfessionesPersonSelect())
                    break;
                case "person":
                    wrapper.appendChild(createTitledPersonSelect())
                    break;
                case "text":
                    const dir = list.getAttribute("dir") || "ltr"
                    let input = document.createElement("input")
                    input.setAttribute("dir", dir)
                    wrapper.appendChild(input)
                    break
                default:
                    console.error("Type '" + type + "' is not implemented yet.")
            }

            const deleteButton = document.createElement("button")

            deleteButton.className = "button delete-button"
            deleteButton.textContent = "-"
            deleteButton.setAttribute("tabindex", -1)
            deleteButton.setAttribute("onclick", "deleteListItem(event)")

            wrapper.appendChild(deleteButton)
            return wrapper
        }

        function deleteListItem(event) {

            const list = event.target.closest(".list")
            const listItem = event.target.closest(".list-item")
            if (listItem && listItem.parentNode) {
                listItem.parentNode.removeChild(listItem)
                listChanged(list)
            } else {
                console.error("Could not remove list item.", listItem, event)
            }
        }

        function addListItem(event) {

            const list = event.target.closest(".list")
            const listItems = list.querySelector(".list-items")
            listItems.appendChild(createListItem(list))
            listChanged(list)
        }

        function listChanged(list) {
            if (list.hasAttribute("data-numbered")) {
                const listItems = list.querySelector(".list-items")

                Array.from(listItems.children).forEach((item, index) => {
                    console.log("SPAN")
                    const span = item.querySelector(":scope >span") || document.createElement("span")
                    span.innerText = index + 1
                    item.insertBefore(span, item.children[0])
                })
            }
        }



        document.querySelectorAll(".data-select").forEach(initializeDataSelect)

        function initializeDataSelect(dbSelect) {

            if (dbSelect.hasAttribute("data-initialized")) return
            dbSelect.setAttribute("data-initialized", true)


            dbSelect.style.position = "relative"

            dbSelect.innerHTML = ""

            const wrapper = document.createElement("div")
            wrapper.setAttribute("type", "search")
            dbSelect.appendChild(wrapper)


            const searchFieldWrapper = document.createElement("div")
            searchFieldWrapper.className = "data-select-search-wrapper"
            wrapper.appendChild(searchFieldWrapper)


            const searchField = document.createElement("input")
            searchField.setAttribute("type", "search")
            searchField.className = "data-select-search"
            searchFieldWrapper.appendChild(searchField)

            const hiddenId = document.createElement("input")
            hiddenId.className = "id-field"
            hiddenId.setAttribute("readonly", true)
            hiddenId.setAttribute("tabindex", -1)
            wrapper.appendChild(hiddenId)

            const addBtn = document.createElement("div")
            addBtn.className = "button add-button"
            addBtn.setAttribute("onclick", "addData(event)")

            const txt = document.createElement("span")
            txt.textContent = "+"
            addBtn.appendChild(txt)


            wrapper.appendChild(addBtn)



            const previewList = document.createElement("div")
            previewList.className = "preview-list"
            searchFieldWrapper.appendChild(previewList)

            const previewCount = 5
            for (let i = 0; i < previewCount; i++) {
                const listEntry = document.createElement("div")
                listEntry.className = "list-item"
                listEntry.setAttribute("onclick", "setListItemById(event)")
                previewList.appendChild(listEntry)

                const text = document.createElement("span")
                text.textContent = "Hello World"
                listEntry.appendChild(text)

            }




            function filter(event) {
                const dbSelect = event.target.closest(".data-select")
                if (dbSelect) {
                    if (!dbSelect.hasAttribute("data-select"))
                        console.error("Data select is missing a 'data-select' attribute.")

                    if (!dbSelect.hasAttribute("data-select-attribute"))
                        console.error("Data select is missing a 'data-select-attribute' attribute.")

                    if (dbSelect.hasAttribute("data-select") && dbSelect.hasAttribute("data-select-attribute")) {
                        const select = dbSelect.getAttribute("data-select")
                        const attribute = dbSelect.getAttribute("data-select-attribute")

                        let targetData = []

                        if (!data[select])
                            data[select] = []

                        targetData = data[select].map(obj => {
                            return {
                                id: obj.id, value: obj[attribute]
                            }
                        })

                        const results = targetData.filter(obj => obj.value.match(event.target.value))
                        const previewList = dbSelect.querySelector(".preview-list")
                        previewList.style.display = "block"

                        const listItems = previewList.querySelectorAll(".list-item")

                        listItems.forEach((item, idx) => {
                            if (idx < results.length) {
                                item.setAttribute("data-id", results[idx].id)
                                item.querySelector("span").textContent = results[idx].value

                                item.style.display = "block"
                            } else {
                                item.removeAttribute("data-id")
                                item.style.display = "none"
                            }
                        })
                    }
                } else {
                    console.error("Could not find dbselect")
                }
            }


            function handleKeyboardInteraction(event) {

                let dataSelect = event.target.closest(".data-select")
                const previewList = dataSelect.querySelector(".preview-list")
                const activeAttr = "data-active-preview"
                if (event.key == "ArrowDown" || event.key == "ArrowUp") {
                    let active = parseInt(previewList.getAttribute(activeAttr))
                    if (isNaN(active)) active = -1
                    let nextActive = (event.key == "ArrowDown") ? active + 1 : active - 1

                    console.log(nextActive)
                    nextActive = Math.min(Math.max(-1, nextActive), previewList.children.length - 1)
                    previewList.setAttribute(activeAttr, nextActive)

                    Array.from(previewList.children).forEach((child, idx) => {
                        if (idx == nextActive) {
                            child.classList.add("active")
                        } else {
                            child.classList.remove("active")
                        }
                    })

                }

                if (event.key == "Enter") {
                    event.preventDefault()

                    let active = parseInt(previewList.getAttribute(activeAttr))
                    console.log("active", active)
                    if (isNaN(active) || active < 0) {


                        const match = getMatch(dbSelect)
                        if (match)
                            updateId(dbSelect)
                        else
                            addData(event)


                    } else {
                        applyListItem(previewList.children[parseInt(active)])
                    }

                    const tabables = document.querySelectorAll("input, button")
                    let next = false
                    let tabindex = 0
                    for (let el of Array.from(tabables)) {
                        if (next) {
                            const otherTabindex = el.tabIndex || 0
                            if (otherTabindex >= tabindex) {
                                el.focus()
                                next = false
                                break;
                            } else continue
                        }

                        if (event.target == el) {
                            next = true
                            tabindex = event.tabIndex || 0
                            console.log(tabindex)
                        }
                    }
                }
            }


            const input = dbSelect.querySelector("input")
            input.addEventListener("focus", (event) => {
                filter(event)
                const previewList = dbSelect.querySelector(".preview-list")
                previewList.style.opacity = 1;
                previewList.style.pointerEvents = null

                input.addEventListener("keydown", handleKeyboardInteraction)

            })
            input.addEventListener("input", (event) => {
                filter(event)

                const dbSelect = event.target.closest(".data-select")
                updateId(dbSelect)

                // if (!dbSelect.timeout) {
                //     setTimeout()
                // }
            })
            input.addEventListener("focusout", (event) => {

                const dbSelect = event.target.closest(".data-select")

                const previewList = dbSelect.querySelector(".preview-list")
                if (previewList.style.display != "none") {
                    TweenLite.to(previewList, 0.3, {
                        opacity: 0,
                        onComplete: () => {
                            previewList.style.pointerEvents = "none"
                        }
                    })
                }
            })

            updateId(dbSelect)


        }

        function getMatch(dbSelect) {
            if (!dbSelect.hasAttribute("data-select"))
                console.error("Data select is missing a 'data-select' attribute.")

            if (!dbSelect.hasAttribute("data-select-attribute"))
                console.error("Data select is missing a 'data-select-attribute' attribute.")

            if (dbSelect.hasAttribute("data-select") && dbSelect.hasAttribute("data-select-attribute")) {
                const select = dbSelect.getAttribute("data-select")
                const attribute = dbSelect.getAttribute("data-select-attribute")

                const input = dbSelect.querySelector("input[type=search]")


                if (!data[select])
                    data[select] = []
                const match = data[select].filter(el => el[attribute] == input.value)

                return (match.length == 1) ? match[0] : null
            }
        }

        function updateId(dbSelect) {

            if (!dbSelect.hasAttribute("data-select"))
                console.error("Data select is missing a 'data-select' attribute.")

            if (!dbSelect.hasAttribute("data-select-attribute"))
                console.error("Data select is missing a 'data-select-attribute' attribute.")

            if (dbSelect.hasAttribute("data-select") && dbSelect.hasAttribute("data-select-attribute")) {
                const select = dbSelect.getAttribute("data-select")
                const attribute = dbSelect.getAttribute("data-select-attribute")

                const input = dbSelect.querySelector("input[type=search]")

                const idField = dbSelect.querySelector(".id-field")
                let button = dbSelect.querySelector(".button")


                const match = getMatch(dbSelect)
                if (match) {
                    button.style.display = "none"
                    idField.style.display = null
                    idField.value = match.id

                } else {
                    button.style.display = null
                    idField.style.display = "none"
                    idField.value = ""
                }

            }
        }

        function setListItemById(event) {
            applyListItem(event.target)
        }

        function applyListItem(item) {
            const dbSelect = item.closest(".data-select")
            const textField = dbSelect.querySelector("input:first-child")
            textField.value = item.textContent
            dbSelect.querySelector(".preview-list").style.display = "none"
            updateId(dbSelect)
        }

        function addData(event) {
            const dbSelect = event.target.closest(".data-select")
            const field = dbSelect.querySelector("input")

            const table = dbSelect.getAttribute("data-select")
            const attribute = dbSelect.getAttribute("data-select-attribute")


            if (field.value != "") {

                if (!data[table])
                    data[table] = []
                const obj = data[table]


                let id = 0;
                obj.forEach(datapoint => {
                    if (datapoint.id >= id) {
                        id = datapoint.id + 1
                    }
                })

                const created = {
                    id
                }
                created[attribute] = field.value


                data[table].push(created)

                localStorage.setItem("data", JSON.stringify(data))

                updateId(dbSelect)
            }
        }



        document.querySelectorAll(".titled-person-select").forEach(initializeTitledPersonSelect)


    </script>
</body>

</html>