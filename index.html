<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration</title>

    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Cabin+Sketch:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"></script>
</head>

<body>

    <div class="preview">
        <span>VORSCHAU</span>
    </div>

    <div class="form">
        <h2>Neue Münze</h2>

        <h3>WICHTIG</h3>
        <p>Dies ist eine Vorschau, die zur Feststellung der Bedienbarkeit und der Nutzerfreundlichkeit dient.
        </p>
        <p>Das Design hat in keinster Weise Anspruch auf einen ästhetischen Wert und wird sich, den Anforderungen nach,
            noch drastisch ändern.</p>
        <p>Die Schrift hat diesen Zeichenstil nicht, weil dieser 'schön' sein soll, sondern um dies zu verdeutlichen!
        </p>

        <p class="important">Das Wichtige sind hier die Eingabefelder und deren Bedienbarkeit.</p>


        <h3>Grunddaten</h3>

        <label for="">Typnummer</label>
        <input type="text">

        <label for="">Treadwell-Id</label>
        <input type="text">


        <label for="">Material</label>
        <div class="data-select" data-select="material" data-select-attribute="name" style="position: relative;">
        </div>

        <label for="">Münzstätte</label>
        <input type="text">

        <label for="">Prägejahr</label>
        <div class="synchronized-calendar">
            <div class="calendar">
                <label for="">Arabisch</label><input type="text" data-arabic>
            </div>
            <div class="calendar">
                <label for="">Gregorianisch</label><input type="text" data-gregorian>
            </div>
        </div>
        <p>
            Die Jahreszahlen sind bidirectional synchronisiert. Wird ein Eingabefeld geändert, so wird das andere
            geupdated.
            Dieses 'update' passiert erst, wenn der außerhalb des Feldes geklickt oder ein neues Feld angewählt wird.
        </p>
        <p>
            Es kann auch mit einem kleinen x gearbeitet werden, wenn entsprechende Daten nicht bekannt sind. Dann wird
            das synchronisierte Feld 'falsch' aktualisiert.
            Im Moment gehe ich davon aus, dass wenn ein x gesetzt wird, alle kleineren Werte des anderen Feldes nicht
            mehr berechenbar sind.
        </p>

        <h3>Islamische Münze</h3>

        <label for="">Nominal</label>
        <div class="data-select" data-select="nominal" data-select-attribute="name" style="position: relative;">
            <input type="search" name="" id="">
            <span style="display:block; position: absolute; top:0; right:0; z-index: 1000;">SEARCH</span>
        </div>

        <label for="">Münzherr</label>
        <div class="reigner">
            <label for="">Titel</label>
            <input type="text">

            <label for="">Person</label>
            <input type="text">
        </div>

        <label for="">Kalif</label>
        <input type="text">

        <div class="conditional-field">
            <div class="label"><input type="checkbox" id="is-designated"><label for="is-designated">Designierter
                    Nachfolger?</label></div>
            <div class="conditional hidden">
                <input type="text" name="" id="">
            </div>
        </div>

        <label for="">Oberherren</label>
        <div class="oberherren list" data-numbered data-type="person" data-num=4>
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>

        </div>
        <span class="comment">* wobei 1 der höchste Oberherr ist</span>


        <label for="">Weitere Personen</label>

        <div class="oberherren list" data-type="type-person" data-num=1>
            <button>+</button>
            <div class="list-item"><input type="text" placeholder="Titel"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>

        </div>


        <hr>
        <h3>Vorderseite</h3>

        <label for="">Feld</label>
        <div class="exemplare list" data-type="positional" data-num=1>
            <button>+</button>
            <div class="list-item">
                <div class="positional"><input type="text"><textarea></textarea></div><button>-</button>
            </div>
        </div>

        <label for="">Umschrift</label>
        <div class="exemplare list" data-type="text" data-num=2>
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>

        </div>

        <h3>Rückseite</h3>

        <label for="">Feld</label>
        <div class="exemplare list" data-type="positional" data-num=1>
            <button>+</button>
            <div class="list-item">
                <div class="positional"><input type="text"><textarea></textarea></div><button>-</button>
            </div>
        </div>

        <label for="">Umschrift</label>
        <div class="exemplare list" data-type="text" data-num=2>
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>

        </div>

        <hr>
        <h3>Weitere Informationen</h3>
        <label for="">Literatur</label>
        <div class="literature list">
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>
        </div>

        <label for="">Exemplare</label>
        <div class="exemplare list">
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>
        </div>


        <label for="">Varianten</label>
        <div class="variants list">
            <button>+</button>
            <div class="list-item"><input type="text"><button>-</button></div>
            <div class="list-item"><input type="text"><button>-</button></div>
        </div>

        <label for="">Besonderheiten</label>
        <textarea></textarea>

        <button id="submit">Speichern</button>
    </div>

    <script src="https://rawgit.com/abdennour/hijri-date/master/cdn/hijri-date-latest.js"></script>
    <script>

        submit.addEventListener("click", () => {
            console.log("YOUR VALUES HAVE BEEN SAVED! GJ")
            window.isDirty = false
        })

        // window.addEventListener("beforeunload", (event) => {
        //     console.log("beforeunload")
        //     // Message will be only shown for legacy browsers.
        //     // Modern browsers provide a boilerplate message for preventing scam!
        //     const msg = "Your changes may be lost."
        //     if (window.isDirty)
        //         event.returnValue = msg

        //     return msg;
        // })

        document.querySelectorAll(".list").forEach(initializeList)
        document.querySelectorAll(".conditional-field").forEach(initializeConditionalField)

        document.querySelectorAll("input, textarea").forEach(el => {
            el.addEventListener("input", setDirty)
        })

        function setDirty() {
            window.isDirty = true
        }

        function initializeConditionalField(el) {
            const checkbox = el.querySelector("input[type=checkbox]")
            const conditional = el.querySelector(".conditional")

            checkbox.addEventListener("input", event => {
                if (event.target.checked == true) {
                    conditional.classList.remove("hidden")
                } else {
                    conditional.classList.add("hidden")

                }
            })
        }

        document.querySelectorAll(".synchronized-calendar").forEach(initializeSynchronizedCalendar)


        function initializeSynchronizedCalendar(el) {
            const gregorianTextField = el.querySelector("input[data-gregorian]")
            const arabicTextField = el.querySelector("input[data-arabic]")

            if (!gregorianTextField) console.error("Synchronized calendar is missing data-gregorian element.")
            if (!arabicTextField) console.error("Synchronized calendar is missing data-arabic element.")

            if (gregorianTextField && arabicTextField) {

                function destructureDate(event) {
                    const value = event.target.value
                    const parts = value.split(".")

                    while (parts.length < 3) {
                        parts.unshift("XX")
                    }

                    let day = parts[0].toString().substr(-2).padStart(2, "0")
                    let month = parts[1].toString().substr(-2).padStart(2, "0")
                    const year = parts[2].toString().substr(-4).padStart(4, "0")

                    return [
                        day,
                        month,
                        year
                    ]

                }

                function allowInput(event, regex) {
                    if (event.key.length > 1) return

                    if (event.target.value.length >= 10) event.preventDefault()
                    else if (!regex.test(event.key)) {
                        console.log("PREVENT")
                        event.preventDefault()
                    } else {

                        if (event.target.value.length == 2 || event.target.value.length == 5) {
                            if (event.key != ".") event.target.value += "."
                        }
                    }
                }

                [gregorianTextField, arabicTextField].forEach(field => {
                    field.addEventListener("paste", (event) => {
                        event.preventDefault()
                    })

                    field.addEventListener("keydown", (event) => {
                        allowInput(event, /[0-9x]/g)
                    })
                })

                gregorianTextField.addEventListener("change", (event) => {
                    const destructuredDate = destructureDate(event)
                    event.target.value = destructuredDate.join(".")


                    const day = parseInt(destructuredDate[0]) - 1 || 1
                    const month = parseInt(destructuredDate[1]) - 1 || 0
                    const year = parseInt(destructuredDate[2]) || 0

                    console.log({
                        day, month, year
                    })

                    let date = new Date(year, month, day)

                    const hijri = date.toHijri()
                    arabicTextField.value = [hijri.getDate().toString().padStart(2, "0"), hijri.getMonth().toString().padStart(2, "0"), hijri.getFullYear().toString().padStart(4, "0")].join(".")
                })

                arabicTextField.addEventListener("change", (event) => {
                    const destructuredDate = destructureDate(event)
                    event.target.value = destructuredDate.join(".")


                    const day = parseInt(destructuredDate[0]) + 1 || 1
                    const month = parseInt(destructuredDate[1]) + 1 || 0
                    const year = parseInt(destructuredDate[2]) || 0

                    console.log({
                        day, month, year
                    })

                    let date = new HijriDate(year, month, day)

                    const hijri = date.toGregorian()
                    gregorianTextField.value = [hijri.getDate().toString().padStart(2, "0"), hijri.getMonth().toString().padStart(2, "0"), hijri.getFullYear().toString().padStart(4, "0")].join(".")
                })
            }

        }

        function initializeList(list) {
            list.innerHTML = ""

            const numbered = list.hasAttribute("data-numbered") ? true : false
            const num = list.getAttribute("data-num") || 0
            const type = list.getAttribute("data-type") || "text"

            let addBtn = document.createElement("button")
            addBtn.textContent = "+"
            list.appendChild(addBtn)


            let listItems = document.createElement("div")
            listItems.className = "list-items"
            list.appendChild(listItems)

            addBtn.addEventListener("click", () => {
                const listItem = createListItem(type)
                listItems.appendChild(listItem)
            })

            for (let i = 0; i < num; i++) {
                const listItem = createListItem(type, (numbered) ? i + 1 : null)
                listItems.appendChild(listItem)
            }
        }

        function createListItem(type, numbered = null) {
            const wrapper = document.createElement("div")
            wrapper.className = "list-item"

            if (numbered) {
                let number = document.createElement("span")
                number.textContent = numbered
                wrapper.appendChild(number)
            }

            switch (type) {
                case "positional":
                    const positional = document.createElement("div")
                    positional.className = "positional"
                    wrapper.appendChild(positional)

                    const pinput = document.createElement("input")
                    positional.appendChild(pinput)

                    const textarea = document.createElement("textarea")
                    textarea.setAttribute("dir", "rtl")
                    positional.appendChild(textarea)
                    break;

                case "type-person":
                    let typeInput = document.createElement("input")
                    typeInput.placeholder = "Type"
                    wrapper.appendChild(typeInput)
                case "person":
                    let titleInput = document.createElement("input")
                    titleInput.placeholder = "Title"
                    wrapper.appendChild(titleInput)
                case "text":
                    let input = document.createElement("input")
                    wrapper.appendChild(input)
                    break
                default:
                    console.error("Type '" + type + "' is not implemented yet.")
            }

            const deleteButton = document.createElement("button")
            deleteButton.textContent = "-"
            deleteButton.setAttribute("onclick", "deleteListItem(event)")

            wrapper.appendChild(deleteButton)
            return wrapper
        }

        function deleteListItem(event) {

            const listItem = event.target.closest(".list-item")
            if (listItem && listItem.parentNode) {
                if (confirm("Do you really want to remove")) {
                    listItem.parentNode.removeChild(listItem)
                }
            } else {
                console.error("Could not remove list item.", listItem, event)
            }
        }


        let defaultData = {
            material: [
                { id: 0, name: "gold" },
                { id: 1, name: "silver" },
                { id: 2, name: "copper" },
            ],
            person: [
                { id: 0, name: "آدَم" },
                { id: 1, name: "أدْرِيَان" },
                { id: 2, name: "أليساندرو" },
                { id: 3, name: "دافيدي" },
                { id: 4, name: "إسْتَبْرَق" },
            ],
            nominal: [
                { id: 0, name: "dirham" },
                { id: 1, name: "halb-dirham" },
            ]
        }


        const data = localStorage.getItem("data") || defaultData


        document.querySelectorAll(".data-select").forEach(dbSelect => {

            dbSelect.style.position = "relative"

            dbSelect.innerHTML = ""

            const wrapper = document.createElement("div")
            wrapper.setAttribute("type", "search")
            dbSelect.appendChild(wrapper)


            const searchField = document.createElement("input")
            searchField.setAttribute("type", "search")
            wrapper.appendChild(searchField)

            const hiddenId = document.createElement("input")
            hiddenId.className = "id-field"
            hiddenId.setAttribute("readonly", true)
            hiddenId.setAttribute("tabindex", -1)
            wrapper.appendChild(hiddenId)

            const addBtn = document.createElement("div")
            addBtn.className = "button add-button"
            addBtn.setAttribute("onclick", "addData(event)")

            const txt = document.createElement("span")
            txt.textContent = "+"
            addBtn.appendChild(txt)


            wrapper.appendChild(addBtn)



            const previewList = document.createElement("div")
            previewList.className = "preview-list"
            dbSelect.appendChild(previewList)

            const previewCount = 5
            for (let i = 0; i < previewCount; i++) {
                const listEntry = document.createElement("div")
                listEntry.className = "list-item"
                listEntry.setAttribute("onclick", "setListItemById(event)")
                previewList.appendChild(listEntry)

                const text = document.createElement("span")
                text.textContent = "Hello World"
                listEntry.appendChild(text)

            }




            function filter(event) {


                const dbSelect = event.target.closest(".data-select")
                if (dbSelect) {
                    if (!dbSelect.hasAttribute("data-select"))
                        console.error("Data select is missing a 'data-select' attribute.")

                    if (!dbSelect.hasAttribute("data-select-attribute"))
                        console.error("Data select is missing a 'data-select-attribute' attribute.")

                    if (dbSelect.hasAttribute("data-select") && dbSelect.hasAttribute("data-select-attribute")) {
                        const select = dbSelect.getAttribute("data-select")
                        const attribute = dbSelect.getAttribute("data-select-attribute")

                        let targetData = []

                        if (data[select]) {
                            targetData = data[select].map(obj => {
                                console.log({
                                    id: obj.id, value: obj[attribute]
                                })
                                return {
                                    id: obj.id, value: obj[attribute]
                                }
                            })
                        }

                        console.log(data[select], targetData)
                        const results = targetData.filter(obj => obj.value.match(event.target.value))


                        const previewList = dbSelect.querySelector(".preview-list")
                        previewList.style.display = "block"

                        const listItems = previewList.querySelectorAll(".list-item")

                        listItems.forEach((item, idx) => {
                            if (idx < results.length) {
                                item.setAttribute("data-id", results[idx].id)
                                item.querySelector("span").textContent = results[idx].value

                                item.style.display = "block"
                            } else {
                                item.removeAttribute("data-id")
                                item.style.display = "none"
                            }
                        })
                    }
                } else {
                    console.error("Could not find dbselect")
                }
            }



            const input = dbSelect.querySelector("input")
            input.addEventListener("focus", (event) => {
                filter(event)
                const previewList = dbSelect.querySelector(".preview-list")
                previewList.style.opacity = 1;
            })
            input.addEventListener("input", (event) => {
                filter(event)
                updateId(event)

                // if (!dbSelect.timeout) {
                //     setTimeout()
                // }
            })
            input.addEventListener("focusout", (event) => {

                const dbSelect = event.target.closest(".data-select")

                const previewList = dbSelect.querySelector(".preview-list")
                console.log(previewList, event.target)
                if (previewList.style.display != "none") {
                    TweenLite.to(previewList, 0.3, {
                        opacity: 0
                    })
                }
            })

        })

        function updateId(event) {
            const dbSelect = event.target.closest(".data-select")

            if (!dbSelect.hasAttribute("data-select"))
                console.error("Data select is missing a 'data-select' attribute.")

            if (!dbSelect.hasAttribute("data-select-attribute"))
                console.error("Data select is missing a 'data-select-attribute' attribute.")

            if (dbSelect.hasAttribute("data-select") && dbSelect.hasAttribute("data-select-attribute")) {
                const select = dbSelect.getAttribute("data-select")
                const attribute = dbSelect.getAttribute("data-select-attribute")

                const input = dbSelect.querySelector("input[type=search]")

                const match = data[select].filter(el => el[attribute] == input.value)

                const idField = dbSelect.querySelector(".id-field")
                let button = dbSelect.querySelector(".button")
                if (match.length == 1) {
                    console.log("MATCH")
                    button.style.display = "none"



                    idField.value = match[0].id

                } else {
                    button.style.display = null
                    idField.value = ""
                }

            }
        }

        function setListItemById(event) {
            const dbSelect = event.target.closest(".data-select")
            const textField = dbSelect.querySelector("input:first-child")
            textField.value = event.target.textContent
            dbSelect.querySelector(".preview-list").style.display = "none"
            updateId(event)
        }

        function addData(event) {
            const dbSelect = event.target.closest(".data-select")
            const field = dbSelect.querySelector("input")

            const table = dbSelect.getAttribute("data-select")
            const attribute = dbSelect.getAttribute("data-select-attribute")

            const obj = data[table]
            let id = 0;
            obj.forEach(datapoint => {
                if (datapoint.id >= id) {
                    id = datapoint.id + 1
                }
            })

            const created = {
                id
            }
            created[attribute] = field.value


            data[table].push(created)

            localStorage.setItem("data", data)

            updateId(event)
        }

    </script>
</body>

</html>